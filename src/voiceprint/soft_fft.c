#define FFT_GLOBALS   
#include "soft_fft.h"   
   
#if SAMPLE_NUM==256   
const float sin_tab[256]={0.000000,0.024541,0.049068,0.073565,0.098017,0.122411,0.146730,0.170962,0.195090,0.219101,0.242980,0.266713,0.290285,0.313682,0.336890,0.359895,0.382683,   
        0.405241,0.427555,0.449611,0.471397,0.492898,0.514103,0.534998,0.555570,0.575808,0.595699,0.615232,0.634393,0.653173,0.671559,0.689541,0.707107,   
        0.724247,0.740951,0.757209,0.773010,0.788346,0.803208,0.817585,0.831470,0.844854,0.857729,0.870087,0.881921,0.893224,0.903989,0.914210,0.923880,   
        0.932993,0.941544,0.949528,0.956940,0.963776,0.970031,0.975702,0.980785,0.985278,0.989177,0.992480,0.995185,0.997290,0.998795,0.999699,1.000000,   
        0.999699,0.998795,0.997290,0.995185,0.992480,0.989177,0.985278,0.980785,0.975702,0.970031,0.963776,0.956940,0.949528,0.941544,0.932993,0.923880,   
        0.914210,0.903989,0.893224,0.881921,0.870087,0.857729,0.844854,0.831470,0.817585,0.803208,0.788346,0.773010,0.757209,0.740951,0.724247,0.707107,   
        0.689541,0.671559,0.653173,0.634393,0.615232,0.595699,0.575808,0.555570,0.534998,0.514103,0.492898,0.471397,0.449611,0.427555,0.405241,0.382683,   
        0.359895,0.336890,0.313682,0.290285,0.266713,0.242980,0.219101,0.195090,0.170962,0.146730,0.122411,0.098017,0.073565,0.049068,0.024541,0.000000,   
        -0.024541,-0.049068,-0.073565,-0.098017,-0.122411,-0.146730,-0.170962,-0.195090,-0.219101,-0.242980,-0.266713,-0.290285,-0.313682,-0.336890,-0.359895,-0.382683,   
        -0.405241,-0.427555,-0.449611,-0.471397,-0.492898,-0.514103,-0.534998,-0.555570,-0.575808,-0.595699,-0.615232,-0.634393,-0.653173,-0.671559,-0.689541,-0.707107,   
        -0.724247,-0.740951,-0.757209,-0.773010,-0.788346,-0.803208,-0.817585,-0.831470,-0.844854,-0.857729,-0.870087,-0.881921,-0.893224,-0.903989,-0.914210,-0.923880,   
        -0.932993,-0.941544,-0.949528,-0.956940,-0.963776,-0.970031,-0.975702,-0.980785,-0.985278,-0.989177,-0.992480,-0.995185,-0.997290,-0.998795,-0.999699,-1.000000,   
        -0.999699,-0.998795,-0.997290,-0.995185,-0.992480,-0.989177,-0.985278,-0.980785,-0.975702,-0.970031,-0.963776,-0.956940,-0.949528,-0.941544,-0.932993,-0.923880,   
        -0.914210,-0.903989,-0.893224,-0.881921,-0.870087,-0.857729,-0.844854,-0.831470,-0.817585,-0.803208,-0.788346,-0.773010,-0.757209,-0.740951,-0.724247,-0.707107,   
        -0.689541,-0.671559,-0.653173,-0.634393,-0.615232,-0.595699,-0.575808,-0.555570,-0.534998,-0.514103,-0.492898,-0.471397,-0.449611,-0.427555,-0.405241,-0.382683,   
        -0.359895,-0.336890,-0.313682,-0.290285,-0.266713,-0.242980,-0.219101,-0.195090,-0.170962,-0.146730,-0.122411,-0.098017,-0.073565,-0.049068,-0.024541};   
#endif   
   
#if SAMPLE_NUM==512   
const float sin_tab[512]={0.000000,0.012272,0.024541,0.036807,0.049068,0.061321,0.073565,0.085797,0.098017,0.110222,0.122411,0.134581,0.146730,0.158858,0.170962,0.183040,0.195090,0.207111,0.219101,0.231058,0.242980,0.254866,0.266713,0.278520,0.290285,0.302006,0.313682,0.325310,0.336890,0.348419,0.359895,0.371317,0.382683,   
        0.393992,0.405241,0.416430,0.427555,0.438616,0.449611,0.460539,0.471397,0.482184,0.492898,0.503538,0.514103,0.524590,0.534998,0.545325,0.555570,0.565732,0.575808,0.585798,0.595699,0.605511,0.615232,0.624859,0.634393,0.643832,0.653173,0.662416,0.671559,0.680601,0.689541,0.698376,0.707107,   
        0.715731,0.724247,0.732654,0.740951,0.749136,0.757209,0.765167,0.773010,0.780737,0.788346,0.795837,0.803208,0.810457,0.817585,0.824589,0.831470,0.838225,0.844854,0.851355,0.857729,0.863973,0.870087,0.876070,0.881921,0.887640,0.893224,0.898674,0.903989,0.909168,0.914210,0.919114,0.923880,   
        0.928506,0.932993,0.937339,0.941544,0.945607,0.949528,0.953306,0.956940,0.960431,0.963776,0.966976,0.970031,0.972940,0.975702,0.978317,0.980785,0.983105,0.985278,0.987301,0.989177,0.990903,0.992480,0.993907,0.995185,0.996313,0.997290,0.998118,0.998795,0.999322,0.999699,0.999925,1.000000,   
        0.999925,0.999699,0.999322,0.998795,0.998118,0.997290,0.996313,0.995185,0.993907,0.992480,0.990903,0.989177,0.987301,0.985278,0.983105,0.980785,0.978317,0.975702,0.972940,0.970031,0.966976,0.963776,0.960431,0.956940,0.953306,0.949528,0.945607,0.941544,0.937339,0.932993,0.928506,0.923880,   
        0.919114,0.914210,0.909168,0.903989,0.898674,0.893224,0.887640,0.881921,0.876070,0.870087,0.863973,0.857729,0.851355,0.844854,0.838225,0.831470,0.824589,0.817585,0.810457,0.803208,0.795837,0.788346,0.780737,0.773010,0.765167,0.757209,0.749136,0.740951,0.732654,0.724247,0.715731,0.707107,   
        0.698376,0.689541,0.680601,0.671559,0.662416,0.653173,0.643832,0.634393,0.624859,0.615232,0.605511,0.595699,0.585798,0.575808,0.565732,0.555570,0.545325,0.534998,0.524590,0.514103,0.503538,0.492898,0.482184,0.471397,0.460539,0.449611,0.438616,0.427555,0.416430,0.405241,0.393992,0.382683,   
        0.371317,0.359895,0.348419,0.336890,0.325310,0.313682,0.302006,0.290285,0.278520,0.266713,0.254866,0.242980,0.231058,0.219101,0.207111,0.195090,0.183040,0.170962,0.158858,0.146730,0.134581,0.122411,0.110222,0.098017,0.085797,0.073565,0.061321,0.049068,0.036807,0.024541,0.012272,0.000000,   
        -0.012272,-0.024541,-0.036807,-0.049068,-0.061321,-0.073565,-0.085797,-0.098017,-0.110222,-0.122411,-0.134581,-0.146730,-0.158858,-0.170962,-0.183040,-0.195090,-0.207111,-0.219101,-0.231058,-0.242980,-0.254866,-0.266713,-0.278520,-0.290285,-0.302006,-0.313682,-0.325310,-0.336890,-0.348419,-0.359895,-0.371317,-0.382683,   
        -0.393992,-0.405241,-0.416430,-0.427555,-0.438616,-0.449611,-0.460539,-0.471397,-0.482184,-0.492898,-0.503538,-0.514103,-0.524590,-0.534998,-0.545325,-0.555570,-0.565732,-0.575808,-0.585798,-0.595699,-0.605511,-0.615232,-0.624859,-0.634393,-0.643832,-0.653173,-0.662416,-0.671559,-0.680601,-0.689541,-0.698376,-0.707107,   
        -0.715731,-0.724247,-0.732654,-0.740951,-0.749136,-0.757209,-0.765167,-0.773010,-0.780737,-0.788346,-0.795837,-0.803208,-0.810457,-0.817585,-0.824589,-0.831470,-0.838225,-0.844854,-0.851355,-0.857729,-0.863973,-0.870087,-0.876070,-0.881921,-0.887640,-0.893224,-0.898674,-0.903989,-0.909168,-0.914210,-0.919114,-0.923880,   
        -0.928506,-0.932993,-0.937339,-0.941544,-0.945607,-0.949528,-0.953306,-0.956940,-0.960431,-0.963776,-0.966976,-0.970031,-0.972940,-0.975702,-0.978317,-0.980785,-0.983105,-0.985278,-0.987301,-0.989177,-0.990903,-0.992480,-0.993907,-0.995185,-0.996313,-0.997290,-0.998118,-0.998795,-0.999322,-0.999699,-0.999925,-1.000000,   
        -0.999925,-0.999699,-0.999322,-0.998795,-0.998118,-0.997290,-0.996313,-0.995185,-0.993907,-0.992480,-0.990903,-0.989177,-0.987301,-0.985278,-0.983105,-0.980785,-0.978317,-0.975702,-0.972940,-0.970031,-0.966976,-0.963776,-0.960431,-0.956940,-0.953306,-0.949528,-0.945607,-0.941544,-0.937339,-0.932993,-0.928506,-0.923880,   
        -0.919114,-0.914210,-0.909168,-0.903989,-0.898674,-0.893224,-0.887640,-0.881921,-0.876070,-0.870087,-0.863973,-0.857729,-0.851355,-0.844854,-0.838225,-0.831470,-0.824589,-0.817585,-0.810457,-0.803208,-0.795837,-0.788346,-0.780737,-0.773010,-0.765167,-0.757209,-0.749136,-0.740951,-0.732654,-0.724247,-0.715731,-0.707107,   
        -0.698376,-0.689541,-0.680601,-0.671559,-0.662416,-0.653173,-0.643832,-0.634393,-0.624859,-0.615232,-0.605511,-0.595699,-0.585798,-0.575808,-0.565732,-0.555570,-0.545325,-0.534998,-0.524590,-0.514103,-0.503538,-0.492898,-0.482184,-0.471397,-0.460539,-0.449611,-0.438616,-0.427555,-0.416430,-0.405241,-0.393992,-0.382683,   
        -0.371317,-0.359895,-0.348419,-0.336890,-0.325310,-0.313682,-0.302006,-0.290285,-0.278520,-0.266713,-0.254866,-0.242980,-0.231058,-0.219101,-0.207111,-0.195090,-0.183040,-0.170962,-0.158858,-0.146730,-0.134581,-0.122411,-0.110222,-0.098017,-0.085797,-0.073565,-0.061321,-0.049068,-0.036807,-0.024541,-0.012272};   
#endif   
   
void SetData(float data,unsigned int i)
{   
    dataR[i]=data;
    dataI[i]=0;
}   
   
void FFT(void)   
{   
    const int count[]={1,2,4,8,16,32,64,128,256,512,1024,2048};   
    int i,xx,n;   
    int L,j,k,b;   
    float TR,TI,temp,Tsin,Tcos;//,p;   
    long m;   
    int x[11]={0};   
    n=FFT_POINT;    
/********** following code invert sequence ************/   
    for(i=0;i<count[n];i++)   
    {    
        xx=0;   
        for(j=0;j<n;j++) {x[j]=0;}   
        for(j=0;j<n;j++) {x[j]=(i/count[j])&0x01;}   
        for(j=0;j<n;j++) {xx=xx+x[j]*count[n-j-1];}   
        dataI[xx]=dataR[i];   
    }   
    for(i=0;i<count[n];i++)   
    {    
        dataR[i]=dataI[i];   
        dataI[i]=0;   
    }   
/************** following code FFT *******************/   
    for(L=1;L<=n;L++)   /* for(1) */   
    {   
        b=1; // i=L-1;   
        b<<=(L-1);  //ÕûÐÍ2µÄn´Î·½¼ò»¯ÔËËã(¼Ó¿ì¼ÆËãËÙ¶È)   
   
        m=SAMPLE_NUM/count[L];   
   
        for(j=0;j<=b-1;j++) /* for (2) */   
        {    
            Tsin=sin_tab[(m*j)%SAMPLE_NUM];   
            Tcos=sin_tab[(m*j+SAMPLE_NUM/4)%SAMPLE_NUM];     
            for(k=j;k<count[n];k=k+2*b) /* for (3) */   
            {                  
                TR=dataR[k];    
                TI=dataI[k];    
                temp=dataR[k+b];   
                dataR[k] = dataR[k]+dataR[k+b]*Tcos+dataI[k+b]*Tsin;   
                dataI[k] = dataI[k]-dataR[k+b]*Tsin+dataI[k+b]*Tcos;   
                dataR[k+b] = TR-dataR[k+b]*Tcos-dataI[k+b]*Tsin;   
                dataI[k+b] = TI+temp*Tsin-dataI[k+b]*Tcos;   
            } /* END for (3) */   
        } /* END for (2) */   
    } /* END for (1) */   
}   

float GetPow(unsigned int k)
{
    return (dataR[k]*dataR[k]+dataI[k]*dataI[k])*0.001953125;
}

#if 0
int32_t soft_fft_data[512]={
        49,  45, -41, -52, -32,  41,  54, -25,  21,  55,  34,  25,  21,
        30, -40, -28, -34,  54,   0,  30, -17,  19, -57,  12,  25,   9,
       -36, -10,   2, -43,  -9,  -6, -56,   8,   0, -31,  -9,  -4,   2,
       -46,  -7, -22,  37, -44, -50,  55, -15, -26,  51,  43, -54, -24,
         5, -53,  46, -28,  13, -48,  20, -42, -34, -46,   9, -32,  20,
       -48,  -6, -47,   5,  54, -35,  56, -26, -55, -45, -18,  57,  -2,
        14,  51, -17,  18, -31,  46,  22, -43, -39, -23, -33,  39,  -7,
        -9,  50, -56,  16,  12, -46, -47,  23,  17, -51,  46,  15, -20,
        49,  28,  20,  49, -32, -24,  42,   9,  51, -47,  -3,  15, -33,
        16,  50,  -8,  -3, -15,  40, -11, -12,  -1, -56,  -1,   9,  25,
       -42,  16,  13,  31,  53,   5,   1,  15,  -4,  26,  49, -20, -22,
        42, -10,  32,  -1,  15, -10,  -8, -51,  45,  35,  47, -24, -35,
       -11, -23,  22,  55, -56,  37,  13,  16,  10,   9, -37, -47, -33,
        16,  37, -43,  54, -43,  57, -14,  47,  -1, -57, -20,  48, -50,
       -33,  26,  55,   1,  48, -14,  36,  12, -16,  38,  -8,  55,  -4,
       -56,   6,  16, -45,  30, -25,  49,  46, -29, -51,  45,  14,  53,
       -14,  15, -24, -23,  23,   0, -55,  21, -57,  51, -51,  37,   5,
        -9,  17,  54, -12, -45,  56,  52,  29, -47,  25, -54, -56,  13,
       -26, -49,   0,  46, -54,  43,   3, -20, -38, -31,  38, -35,  47,
        39, -42,  54,  18,  21, -13, -23,  17,  33, -10,  16,  27, -38,
        26,  -6, -35,  28, -51,  -3,  37,   7, -15,  41,  -8,  47, -37,
        12, -42, -57,  35, -53,  39,  50, -56,  -1,  13, -11,  35, -27,
       -36, -33,  46,  49, -14,  14, -15,   9, -15,  -8, -51, -36,  56,
        -8, -53,  -9, -19, -32, -54,  -4, -32,  38,   1, -50,  30,   3,
         7, -15,  49, -16,  16, -44,   8,   4, -53,  53, -40, -10,   4,
         3,  39,  11,  25,  37, -55,  30, -29, -16,  55, -26,  38, -34,
       -46, -18, -27,  42,  42,  38, -30,  34, -36,  43,  47,  30, -11,
        51,  25,   7, -17, -28, -47, -35,  40,  35, -56,  43,   8, -27,
       -31,   5,   4, -51,  29,  16, -12, -55,   0, -27,  40,  28, -51,
       -53,  13,  54,  34, -56,  47,   2,   9, -27,  31,  19,  -5,  13,
        -3,  -3,  -1, -53,  27,  25,  10, -26,  32, -19,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0
};
#endif

void soft_calc_fft(float *input, float *power)
{
    for(int i = 0; i < 512;i++) 
        SetData(input[i], i);
    
    //SetData(100,256);
    
        //SetData(soft_fft_data[i], i);
    FFT();
    //printf("get fft power:\r\n");
    for(int i = 0; i < 256; i++)
    {
        //if(i % 8 == 0) printf("\r\n");
        power[i] = GetPow(i);
        //printf("%f, ",GetPow(i));
    }
    //printf("\r\nend of fft power!\r\n");
}
